version: 2.1

jobs:
 
 build:
   docker:
     - image: python:3.7.3-stretch

   working_directory: ~/repo

   steps:
     - checkout
     - restore_cache:
         keys:
           - v1-dependencies-{{ checksum "requirements.txt" }}
           - v1-dependencies-

     - run:
        name: install dependencies
        command: |
         python3 -m venv venv
         . venv/bin/activate
         make install
         wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
         chmod +x /bin/hadolint
     - save_cache:
        paths:
         - ./venv
        key: v1-dependencies-{{ checksum "requirements.txt" }}

# run lint!
     - run:
        name: run lint
        command: |
         . venv/bin/activate
           make lint 

 buildimage:
   environment:
     IMAGE_NAME: josephjoy038/caprepo
   docker:
     - image: circleci/buildpack-deps:stretch
   
   steps:
     - checkout
     - setup_remote_docker
     - run:
         name: Build Docker image
         command: |
           docker build -t $IMAGE_NAME:latest .
     - run:
         name: Archive Docker image
         command: docker save -o image.tar $IMAGE_NAME
     - persist_to_workspace:
         root: .
         paths:
           - ./image.tar

 publishimage:
   environment:
     IMAGE_NAME: josephjoy038/caprepo
   docker:
     - image: circleci/buildpack-deps:stretch
 
   steps:
      - attach_workspace:
          at: /tmp/workspace
      - setup_remote_docker
      - run:
          name: Load archived Docker image
          command: docker load -i /tmp/workspace/image.tar
      - run:
          name: Publish Docker Image to Docker Hub.
          command: |
            docker login -u "$DOCKERHUB_USERNAME" "$DOCKERHUB_PASS"
            docker push $IMAGE_NAME:latest 

workflows:
  default:
    jobs:
      - build
      - buildimage
      - publishimage
          requires: [buildimage]